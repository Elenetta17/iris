FROM python:3.8
LABEL key="Matthieu Gouel <matthieu.gouel@lip6.fr>"

WORKDIR /app

# Compilation tools
RUN apt-get update
RUN apt-get -y install gnupg gcc g++ cmake libboost-all-dev git autoconf automake build-essential
RUN apt -y install --reinstall ca-certificates
RUN apt-get -y clean all
RUN apt-get update

# Terashuf
RUN git clone https://github.com/alexandres/terashuf.git
RUN cd terashuf && make -j8 && cd ..
ENV TMPDIR /app/reader/resources/
ENV MEMORY 24

RUN mkdir vendors
COPY vendors/diamond-miner-core vendors/diamond-miner-core

RUN pip install --upgrade pip
RUN pip install poetry uvicorn
RUN poetry config virtualenvs.create false

COPY pyproject.toml pyproject.toml
RUN poetry install --no-root --no-dev

COPY iris iris

RUN mkdir results

CMD ["dramatiq", "iris.worker.hook"]